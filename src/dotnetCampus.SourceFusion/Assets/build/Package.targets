<Project>

  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>
  
  <!-- 计算所有编译目标所需的各种属性和参数。 -->
  <Target Name="_SourceFusionEvaluateProperties">
    <PropertyGroup>
      <_SourceFusionRoot>$(MSBuildThisFileDirectory)..\</_SourceFusionRoot>
      <_SourceFusionSourceFolder>$(_SourceFusionRoot)src\</_SourceFusionSourceFolder>
      <_SourceFusionToolPath>$(_SourceFusionRoot)tools\dotnetCampus.SourceFusion.exe</_SourceFusionToolPath>
      <_SourceFusionWorkingFolder>$(IntermediateOutputPath)SourceFusion\</_SourceFusionWorkingFolder>
      <_SourceFusionToolsFolder>$(_SourceFusionWorkingFolder)Tools\</_SourceFusionToolsFolder>
      <_SourceFusionGeneratedCodeFolder>$(_SourceFusionWorkingFolder)GeneratedCodes\</_SourceFusionGeneratedCodeFolder>
    </PropertyGroup>
    <Message Text="1.1 初始化 SourceFusion 全部属性" />
  </Target>
  
  <!-- 避免依赖传递。 -->
  <Target Name="_SourceFusionPrivateAssets"
          BeforeTargets="CollectPackageReferences">
    <ItemGroup>
      <PackageReference Update="dotnetCampus.SourceFusion" PrivateAssets="all" />
    </ItemGroup>
    <Message Text="1.2 避免依赖传递" />
  </Target>

  <!-- 创建 SourceFusion 需要的文件夹。 -->
  <Target Name="_SourceFusionEnsureDirectories"
          DependsOnTargets="_SourceFusionEvaluateProperties">
    <ItemGroup>
      <_SourceFusionCreatedDirectory Include="$(_SourceFusionWorkingFolder)" />
      <_SourceFusionCreatedDirectory Include="$(_SourceFusionToolsFolder)" />
      <_SourceFusionCreatedDirectory Include="$(_SourceFusionGeneratedCodeFolder)" />
    </ItemGroup>
    <MakeDir Directories="@(_SourceFusionCreatedDirectory)" ContinueOnError="false" />
    <Message Text="2. 创建 SourceFusion 需要的文件夹：" />
    <Message Text="   @(_SourceFusionCreatedDirectory)" />
  </Target>

  <!-- 写入 SourceFusion 需要的命令行参数。 -->
  <Target Name="_SourceFusionWriteArgs"
          DependsOnTargets="_SourceFusionEnsureDirectories">
    <PropertyGroup>
      <_SourceFusionProjectPropertyFile>$(_SourceFusionToolsFolder)CommandArgs.txt</_SourceFusionProjectPropertyFile>
    </PropertyGroup>
    <ItemGroup>
      <!--这里正在按格式编写配置文件，配置文件尚未开源，所以暂时没有名字。-->
      <_SourceFusionCommandArgLine Include=">" />
      <_SourceFusionCommandArgLine Include="RootNamespace" />
      <_SourceFusionCommandArgLine Include="$(RootNamespace)" />
      <_SourceFusionCommandArgLine Include=">" />
      <_SourceFusionCommandArgLine Include="Compile" />
      <_SourceFusionCommandArgLine Include="@(Compile)" />
      <_SourceFusionCommandArgLine Include=">" />
      <_SourceFusionCommandArgLine Include="PrecompileFilter" />
      <_SourceFusionCommandArgLine Include="@(PrecompileFilter)" />
      <_SourceFusionCommandArgLine Include=">" />
      <_SourceFusionCommandArgLine Include="ReferencePath" />
      <_SourceFusionCommandArgLine Include="@(ReferencePath)" />
      <_SourceFusionCommandArgLine Include=">" />
    </ItemGroup>
    <WriteLinesToFile File="$(_SourceFusionProjectPropertyFile)" Lines="@(_SourceFusionCommandArgLine)" Overwrite="True" />
    <Message Text="3.1 写入编译器所需的命令行参数：" />
    <Message Text="    $(_SourceFusionProjectPropertyFile)" />
    <Message Text="    @(_SourceFusionCommandArgLine)" />
  </Target>

  <!-- 进行重新编译测试。 -->
  <Target Name="_SourceFusionRebuildingTest"
          DependsOnTargets="_SourceFusionEnsureDirectories"
          Inputs="$(MSBuildProjectFullPath)"
          Outputs="$(_SourceFusionToolsFolder)RebuildingTest.txt">
    <ItemGroup>
      <_SourceFusionRebuildingTestLine Include="true" />
    </ItemGroup>
    <CallTarget Targets="_SourceFusionRebuildingTestInitialize" />
    <WriteLinesToFile File="$(_SourceFusionToolsFolder)RebuildingTest.txt" Lines="@(_SourceFusionRebuildingTestLine)" Overwrite="True" />
    <Message Text="3.2 检测全量编译与差量编译" />
  </Target>
  <Target Name="_SourceFusionRebuildingTestInitialize">
    <PropertyGroup>
      <_SourceFusionRebuildRequired>true</_SourceFusionRebuildRequired>
    </PropertyGroup>
    <Message Text="    检测到本次编译为全量编译 True" />
  </Target>

  <!-- 执行 SourceFusion 核心编译过程。 -->
  <Target Name="_SourceFusionGenerateCode"
          DependsOnTargets="_SourceFusionWriteArgs;_SourceFusionRebuildingTest">
    <PropertyGroup>
      <_SourceFusionRebuildRequired Condition="'$(_SourceFusionRebuildRequired)' == ''">false</_SourceFusionRebuildRequired>
    </PropertyGroup>
    <Exec ConsoleToMSBuild="True"
          Command="&quot;$(_SourceFusionToolPath)&quot; &quot;$(MSBuildProjectDirectory)&quot; -t $(_SourceFusionToolsFolder) -c $(_SourceFusionGeneratedCodeFolder) -p &quot;$(_SourceFusionProjectPropertyFile)&quot; -s $(DefineConstants) --rebuild $(_SourceFusionRebuildRequired)">
      <Output TaskParameter="ConsoleOutput" PropertyName="_SourceFusionOutputOfGenerateCode" />
      <Output TaskParameter="ExitCode" PropertyName="_SourceFusionMainExitCode" />
    </Exec>
    <Message Text="4. 执行核心编译" />
  </Target>

  <!-- 使用 SourceFusion 生成的新源码。 -->
  <Target Name="_SourceFusionIncludeGeneratedCode"
          DependsOnTargets="_SourceFusionGenerateCode"
          BeforeTargets="CoreCompile">
    <CreateItem Include="$(_SourceFusionOutputOfGenerateCode)">
      <Output TaskParameter="Include" ItemName="_SourceFusionExcludedCompileFile" />
    </CreateItem>
    <ItemGroup>
      <_SourceFusionIncludedCompileFile Include="$(_SourceFusionGeneratedCodeFolder)\*.cs" />
      <Compile Include="@(_SourceFusionIncludedCompileFile)" />
      <Compile Remove="@(_SourceFusionExcludedCompileFile)" />
    </ItemGroup>
    <Message Text="5.1 使用编译生成的源代码：" />
    <Message Condition=" '$(_SourceFusionRebuildRequired)' == 'true' " Importance="High" Text="    引入新的文件：@(_SourceFusionIncludedCompileFile)" />
    <Message Condition=" '$(_SourceFusionRebuildRequired)' == 'true' " Importance="High" Text="    排除旧的文件：@(_SourceFusionExcludedCompileFile)" />
    <Message Condition=" '$(_SourceFusionRebuildRequired)' != 'true' " Text="    引入新的文件：@(_SourceFusionIncludedCompileFile)" />
    <Message Condition=" '$(_SourceFusionRebuildRequired)' != 'true' " Text="    排除旧的文件：@(_SourceFusionExcludedCompileFile)" />
  </Target>

  <!-- 将中间生成过程中替换的源代码文件还原回去，这样 Visual Studio 中就不会以为原来的源代码文件是杂项文件了。 -->
  <Target Name="_SourceFusionRestoreGeneratedCode"
          DependsOnTargets="_SourceFusionIncludeGeneratedCode"
          AfterTargets="AfterBuild">
    <ItemGroup>
      <Compile Remove="@(_SourceFusionIncludedCompileFile)" />
      <Compile Include="@(_SourceFusionExcludedCompileFile)" />
    </ItemGroup>
    <Message Text="6.1 还原编译过程中对文件替换的修改（这可以避免 Visual Studio 认为原来的文件已被弃用导致不做代码分析）" />
  </Target>
  
  <!-- 标记 SourceFusion 提供的 API 源码。
       实际上这些源代码仅供 Visual Studio 源代码分析使用，不会真正进入项目。
       因此，我们仅仅标记有哪些文件而已，无需将其加入 CoreCompile。 -->
  <Target Name="_SourceFusionEvaluateIncludeSourceFiles"
          BeforeTargets="CoreCompile"
          DependsOnTargets="_SourceFusionEvaluateProperties">
    <ItemGroup>
      <_SourceFusionCompile Include="$(_SourceFusionSourceFolder)**\*.cs" />
      <_SourceFusionAllCompile Include="@(_SourceFusionCompile)" />
      <Compile Include="@(_SourceFusionCompile)" />
    </ItemGroup>
    <Message Text="5.2 标记 API 相关的源码：@(_SourceFusionCompile)" />
  </Target>
  
  <!-- 引入 SourceFusion 提供的 API 源码。
       实际上这些源代码仅供 Visual Studio 源代码分析使用，不会真正进入项目。
       因此，我们仅在 AfterBuild 的时候将其引入即可，无需加入 CoreCompile。 -->
  <Target Name="_SourceFusionIncludeSourceFiles"
          AfterTargets="AfterBuild"
          DependsOnTargets="_SourceFusionEvaluateIncludeSourceFiles">
    <ItemGroup>
      <Compile Include="@(_SourceFusionCompile)" />
    </ItemGroup>
    <Message Text="6.2 假装引入 API 相关的源码：@(_SourceFusionCompile)" />
  </Target>

  <!-- 添加清理 SourceFusion 的依赖。 -->
  <PropertyGroup>
    <CleanDependsOn>$(CleanDependsOn);_SourceFusionClean</CleanDependsOn>
  </PropertyGroup>

  <!-- 清理 SourceFusion 计算所得的文件。 -->
  <Target Name="_SourceFusionClean"
          DependsOnTargets="_SourceFusionEvaluateProperties">
    <ItemGroup>
      <_SourceFusionDeletedDirectory Include="$(_SourceFusionToolsFolder)" />
      <_SourceFusionDeletedDirectory Include="$(_SourceFusionGeneratedCodeFolder)" />
      <_SourceFusionDeletedDirectory Include="$(_SourceFusionWorkingFolder)" />
    </ItemGroup>
    <RemoveDir Directories="@(_SourceFusionDeletedDirectory)" />
    <Message Text="清理文件夹：" />
    <Message Text="  @(_SourceFusionDeletedDirectory)" />
  </Target>

</Project>