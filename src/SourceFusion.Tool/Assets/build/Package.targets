<Project>

  <PropertyGroup Condition=" $(IsInDemoToolDebugMode) == 'True' ">
    <TransformCodeToolPath>$(MSBuildThisFileDirectory)..\..\bin\$(Configuration)\net47\codet.exe</TransformCodeToolPath>
  </PropertyGroup>

  <PropertyGroup Condition=" $(IsInDemoToolDebugMode) != 'True' ">
    <TransformCodeToolPath>$(MSBuildThisFileDirectory)..\tools\net47\codet.exe</TransformCodeToolPath>
  </PropertyGroup>

  <PropertyGroup Condition=" $(UseDotNetCore) == 'True' ">
    <TransformCodeToolPath>dotnet $(MSBuildThisFileDirectory)..\tools\netcoreapp2.0\codet.dll</TransformCodeToolPath>
  </PropertyGroup>

  <Target Name="_SourceFusionCreateDirectories" BeforeTargets="_SourceFusionWriteCompilingArgs;_SourceFusionWriteFilterArgs">
    <PropertyGroup>
      <SourceFusionWorkingFolder Condition="'$(SourceFusionWorkingFolder)' == ''">obj\$(Configuration)\</SourceFusionWorkingFolder>
    </PropertyGroup>
    <ItemGroup>
      <SourceFusionDirectory Include="$(SourceFusionWorkingFolder)" />
      <SourceFusionDirectory Include="$(SourceFusionWorkingFolder)SourceFusion.Tools\" />
      <SourceFusionDirectory Include="$(SourceFusionWorkingFolder)SourceFusion.GeneratedCodes\" />
    </ItemGroup>
    <MakeDir Directories="@(SourceFusionDirectory)" ContinueOnError="false" />
  </Target>

  <Target Name="_SourceFusionWriteCompilingArgs" BeforeTargets="SourceFusionGenerateCode">
    <PropertyGroup>
      <SourceFusionCompilingArgsFile Condition=" '$(SourceFusionCompilingArgsFile)' == '' ">$(SourceFusionWorkingFolder)SourceFusion.Tools\CompilingArgs.txt</SourceFusionCompilingArgsFile>
    </PropertyGroup>
    <WriteLinesToFile File="$(SourceFusionCompilingArgsFile)" Lines="@(Compile)" Overwrite="True" />
  </Target>

  <Target Name="_SourceFusionWriteFilterArgs" BeforeTargets="SourceFusionGenerateCode">
    <PropertyGroup>
      <SourceFusionFilterArgsFile Condition=" '$(SourceFusionFilterArgsFile)' == '' ">$(SourceFusionWorkingFolder)SourceFusion.Tools\FilterArgs.txt</SourceFusionFilterArgsFile>
      <PrecompileFilter Condition=" '$(PrecompileFilter)' == '' ">*.cs</PrecompileFilter>
    </PropertyGroup>
    <WriteLinesToFile File="$(SourceFusionFilterArgsFile)" Lines="@(PrecompileFilter)" Overwrite="True" />
  </Target>

  <Target Name="_SourceFusionRebuildingTest" BeforeTargets="SourceFusionGenerateCode"
          Inputs="$(MSBuildProjectFullPath)" Outputs="$(SourceFusionWorkingFolder)SourceFusion.Tools\RebuildingTest.txt">
    <PropertyGroup>
      <SourceFusionRebuildRequired>true</SourceFusionRebuildRequired>
    </PropertyGroup>
    <ItemGroup>
      <RebuildingTestLine Include="true" />
    </ItemGroup>
    <WriteLinesToFile File="$(SourceFusionWorkingFolder)SourceFusion.Tools\RebuildingTest.txt" Lines="@(RebuildingTestLine)" Overwrite="True" />
  </Target>
    
  <Target Name="SourceFusionGenerateCode" BeforeTargets="CoreCompile">
    <PropertyGroup>
      <SourceFusionGeneratedCodeFolder>$(SourceFusionWorkingFolder)SourceFusion.GeneratedCodes</SourceFusionGeneratedCodeFolder>
    </PropertyGroup>
    <Exec ConsoleToMSBuild="True"
          Command="&quot;$(TransformCodeToolPath)&quot; -p &quot;$(MSBuildProjectDirectory)&quot; -i $(SourceFusionGeneratedCodeFolder) -c &quot;$(SourceFusionCompilingArgsFile)&quot; -f &quot;$(SourceFusionFilterArgsFile)&quot;">
      <Output TaskParameter="ConsoleOutput" PropertyName="_OutputOfSourceFusionGenerateCode" />
      <Output TaskParameter="ExitCode" PropertyName="_ExitCodeOfSourceFusion" />
    </Exec>
  </Target>

  <Target Name="_IncludeSourceFusionGeneratedCode" Condition="$(_ExitCodeOfSourceFusion) == '0' " AfterTargets="SourceFusionGenerateCode">
    <CreateItem Include="$(_OutputOfSourceFusionGenerateCode)">
      <Output TaskParameter="Include" ItemName="_ExcludedCompileFile" />
    </CreateItem>
    <ItemGroup>
      <Compile Include="$(SourceFusionGeneratedCodeFolder)\*.cs" />
      <Compile Remove="@(_ExcludedCompileFile)" />
    </ItemGroup>
    <Message Text="编译时排除的文件：@(_ExcludedCompileFile)" />
  </Target>

</Project>